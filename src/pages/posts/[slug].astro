---
export const prerender = false;

import MainLayout from "../../layouts/MainLayout.astro";
import { posts as seedPosts } from "../../data/posts";

import { supabase } from "../../lib/supabaseClient";

const { slug } = Astro.params;

const isUuid =
  typeof slug === "string" &&
  /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(slug);

let post = null;


if (isUuid) {
  const { data, error } = await supabase
    .from("posts")
    .select("*")
    .eq("id", slug)
    .single();

  if (!error && data) {
    post = {
      title: data.title ?? "Untitled",
      category: data.category ?? "General",
      author: data.author ?? "You",
      date: data.created_at ? new Date(data.created_at).toLocaleDateString() : "", 
      image: data.cover_image && String(data.cover_image).trim().length > 0 ? String(data.cover_image).trim() : null,
      content: data.content ?? "",
      fromDb: true,
    };
  }
} else {
  const seed = seedPosts.find((p) => p.slug === slug);
  if (seed) {
    post = { ...seed, fromDb: false };
  } else {
    const { data, error } = await supabase
      .from("posts")
      .select("*")
      .eq("slug", slug)
      .single();

    if (!error && data) {
      post = {
        title: data.title ?? "Untitled",
        category: data.category ?? "General",
        author: data.author ?? "You",
        date: data.created_at ? new Date(data.created_at).toLocaleDateString() : "",
        image: data.cover_image && String(data.cover_image).trim().length > 0 ? String(data.cover_image).trim() : null,

        content: data.content ?? "",
        fromDb: true,
      };
    }
  }
}

if (!post) return Astro.redirect("/posts");

// Mock comments
const comments = [
  { name: "Alex Chen", time: "2 hours ago", text: "Great article!" },
  { name: "Marcus Johnson", time: "5 hours ago", text: "Totally agree!" },
];
---

<MainLayout title={`${post.title} | The Modern Journal`} fullWidth={false}>
  <section class="py-14 max-w-4xl mx-auto px-6">
    <p class="text-blue-600 text-sm font-semibold uppercase tracking-wide">
      {post.category}
    </p>

    <h1 class="mt-3 text-5xl font-extrabold text-slate-900 leading-tight">
      {post.title}
    </h1>

    <div class="mt-4 flex items-center gap-3 text-sm text-slate-500">
      <span class="font-semibold text-slate-700">{post.author}</span>
      <span>•</span>
      <span>{post.date}</span>
    </div>

  <!-- Image -->
<div class="mt-8 overflow-hidden rounded-xl border border-slate-200 shadow-sm bg-slate-100">
  {post.image && String(post.image).trim().length > 0 ? (
    <img
      src={post.image}
      alt={post.title}
      class="w-full h-[420px] object-cover"
      loading="lazy"
    />
  ) : (
    <div class="w-full h-[420px] flex items-center justify-center">
      <div class="w-14 h-14 rounded-full bg-white/70 border border-slate-200 flex items-center justify-center text-slate-400">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7" aria-hidden="true">
          <path d="M4 5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5Zm2 0v14h12V5H6Zm2.5 9.5 2-2 2 2.5 2.5-3L18 16H8.5Z" />
        </svg>
      </div>
    </div>
  )}
</div>


    <article class="mt-10 prose prose-slate max-w-none">
      {post.fromDb ? <p>{post.content}</p> : <Fragment set:html={post.content} />}
    </article>

    <hr class="my-12 border-slate-200" />

    <section>
      <h2 class="text-2xl font-bold text-slate-900">Discussion</h2>

      <div class="mt-10 space-y-8">
        {comments.map((c) => (
          <div class="flex gap-4">
            <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-600">
              {c.name[0]}
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-3">
                <p class="font-semibold text-slate-900">{c.name}</p>
                <p class="text-xs text-slate-400">{c.time}</p>
              </div>
              <p class="mt-2 text-sm text-slate-600 leading-relaxed">{c.text}</p>
            </div>
          </div>
        ))}
      </div>

      <div class="mt-10">
        <a href="/posts" class="text-blue-600 font-medium hover:underline">← Back to Posts</a>
      </div>
    </section>
  </section>
</MainLayout> 