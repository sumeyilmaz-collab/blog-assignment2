---
// src/pages/account.astro
import MainLayout from "../layouts/MainLayout.astro";
import { supabase } from "../lib/supabaseClient";

export const prerender = false;

let error = "";
let success = "";

const { data: sessionData } = await supabase.auth.getSession();
const session = sessionData.session;

if (!session) return Astro.redirect("/login");

const user = session.user;

// POST actions (logout, delete)
if (Astro.request.method === "POST") {
  const formData = await Astro.request.clone().formData();
  const action = formData.get("action");

  if (action === "logout") {
    await supabase.auth.signOut();
    return Astro.redirect("/login");
  }

  if (action === "delete") {
    const postId = formData.get("post_id")?.toString();

    if (!postId) {
      error = "Post id missing.";
    } else {
      const { error: deleteError } = await supabase
        .from("posts")
        .delete()
        .eq("id", postId)
        .eq("user_id", user.id); // âœ… sadece kendi postu

      if (deleteError) error = deleteError.message;
      else success = "Post deleted.";
    }
  }
}

// My posts
const { data: myPosts, error: postsError } = await supabase
  .from("posts")
  .select("id,title,created_at")
  .eq("user_id", user.id)
  .order("created_at", { ascending: false });

if (postsError) error = postsError.message;

// Name (supabase auth userâ€™da Ã§oÄŸu zaman yok â†’ fallback)
const displayName =
  user.user_metadata?.full_name ||
  user.user_metadata?.name ||
  user.email?.split("@")[0] ||
  "No name";
---

<MainLayout title="Account | The Modern Journal" fullWidth={true}>
  <section class="bg-[#f5f4f0] py-16">
    <div class="max-w-5xl mx-auto px-6">

      <div class="mb-10">
        <h1 class="text-4xl font-extrabold text-slate-900">My Account</h1>
        <p class="mt-3 text-slate-600 text-lg">Welcome back, you are logged in ðŸŽ‰</p>
      </div>

      {error && (
        <div class="mb-6 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-red-700 text-sm">
          {error}
        </div>
      )}

      {success && (
        <div class="mb-6 rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-green-700 text-sm">
          {success}
        </div>
      )}

      <div class="grid gap-10 md:grid-cols-2 mb-14">

        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-10">
          <h2 class="text-xl font-bold text-slate-900 mb-6">Account Info</h2>

          <div class="space-y-1">
            <p class="text-lg font-semibold text-slate-900">{displayName}</p>
            <p class="text-slate-600">{user.email}</p>
          </div>

          <p class="mt-8 text-sm text-slate-500 leading-relaxed">
            Profile editing will be available once database integration is added.
          </p>
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-10">
          <h2 class="text-xl font-bold text-slate-900 mb-6">Actions</h2>

          <div class="flex flex-col gap-4">
            <a
              href="/create-post"
              class="w-full text-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition shadow"
            >
              Create New Post
            </a>

            <form method="POST">
              <input type="hidden" name="action" value="logout" />
              <button
                type="submit"
                class="w-full px-6 py-3 border border-slate-300 text-slate-800 font-semibold rounded-lg hover:bg-slate-100 transition"
              >
                Logout
              </button>
            </form>
          </div>
        </div>

      </div>

      <div>
        <h2 class="text-2xl font-bold text-slate-900 mb-6">My Posts</h2>

        {(!myPosts || myPosts.length === 0) ? (
          <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-10">
            <p class="text-slate-700">No posts yet.</p>
          </div>
        ) : (
          <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
            <table class="w-full text-left text-sm">
              <thead class="bg-slate-50 text-slate-600">
                <tr>
                  <th class="px-6 py-4 font-semibold">Title</th>
                  <th class="px-6 py-4 font-semibold">Date</th>
                  <th class="px-6 py-4 font-semibold">Actions</th>
                </tr>
              </thead>

              <tbody>
                {myPosts.map((post) => (
                  <tr class="border-t border-slate-200">
                    <td class="px-6 py-4">{post.title}</td>
                    <td class="px-6 py-4">
                      {new Date(post.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4">
                      <div class="flex gap-3">
                        <a
                          href={`/edit-post/${post.id}`}
                          class="px-4 py-2 text-xs font-semibold rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition"
                        >
                          Edit
                        </a>

                        <form method="POST">
                          <input type="hidden" name="action" value="delete" />
                          <input type="hidden" name="post_id" value={post.id} />
                          <button
                            type="submit"
                            class="px-4 py-2 text-xs font-semibold rounded-md bg-red-100 text-red-700 hover:bg-red-200 transition"
                          >
                            Delete
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

    </div>
  </section>
</MainLayout>
