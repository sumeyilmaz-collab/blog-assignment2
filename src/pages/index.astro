---
export const prerender = false;

import MainLayout from "../layouts/MainLayout.astro";
import { posts as seedPosts } from "../data/posts";
import { supabase } from "../lib/supabaseClient";

// Supabase'den published postları çek (en yeni önce)
const { data: dbPosts, error } = await supabase
  .from("posts")
  .select("*")
  .eq("status", "published")
  .order("created_at", { ascending: false });

if (error) console.error("Supabase latest posts error:", error);

// DB postlarını UI formatına map'le
const mappedDbPosts = (dbPosts ?? []).map((p) => ({
  id: p.id ?? null,
  slug: p.slug ?? null,
  title: p.title ?? "Untitled",
  category: p.category ?? "General",
  image:
    p.cover_image && String(p.cover_image).trim().length > 0
      ? String(p.cover_image).trim()
      : null,
  desc:
    (p.content ?? "").slice(0, 140) +
    ((p.content ?? "").length > 140 ? "..." : ""),
  author: p.author ?? "You",
  date: p.created_at ? new Date(p.created_at).toLocaleDateString() : "",
  // sorting için ISO-like:
  createdAt: p.created_at ? new Date(p.created_at).getTime() : 0,
}));

// Seed postlar için sorting alanı ekle
const mappedSeedPosts = (seedPosts ?? []).map((p) => ({
  ...p,
  id: null,
  createdAt: p.dateISO ? new Date(p.dateISO).getTime() : 0,
}));

// Birleştir (DB önce, seed sonra)
const combined = [...mappedDbPosts, ...mappedSeedPosts];

// Unique key (DB id, seed slug)
const unique = Array.from(
  new Map(combined.map((p) => [p.id ? `id:${p.id}` : `slug:${p.slug}`, p])).values()
);

// En güncel 5
const latestPosts = [...unique].sort((a, b) => (b.createdAt ?? 0) - (a.createdAt ?? 0)).slice(0, 5);
---

<MainLayout title="Home | The Modern Journal" fullWidth={true}>
  <!-- HERO -->
  <section class="w-full bg-gradient-to-r from-slate-950 via-slate-900 to-indigo-950 py-24 text-center text-white">
    <div class="max-w-5xl mx-auto px-6">
      <h1 class="text-5xl font-bold tracking-tight">Thoughts, stories, and ideas.</h1>
      <p class="mt-4 text-lg text-slate-300 max-w-2xl mx-auto">
        Explore the universe of Web, design and technology through articles.
      </p>
      <a href="/posts" class="inline-block mt-8 px-6 py-3 rounded-md bg-blue-600 text-white font-semibold shadow hover:bg-blue-700 transition">
        Read Articles
      </a>
    </div>
  </section>

  <!-- LATEST POSTS -->
  <section class="bg-[#fbf8f3] py-14">
    <div class="max-w-6xl mx-auto px-6">
      <h2 class="text-2xl font-bold text-slate-900 mb-10">Latest Posts</h2>

      <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-2">
        {latestPosts.map((post) => {
          const href = `/posts/${post.id ?? post.slug}`;
          const hasImage = post.image && String(post.image).trim().length > 0;

          return (
            <a
              href={href}
              class="group bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-lg transition overflow-hidden flex flex-col h-full"
            >
              {/* IMAGE / PLACEHOLDER */}
              <div class="h-56 w-full overflow-hidden bg-slate-100">
                {hasImage ? (
                  <img
                    src={post.image}
                    alt={post.title}
                    class="h-full w-full object-cover group-hover:scale-105 transition duration-300"
                    loading="lazy"
                  />
                ) : (
                  <div class="h-full w-full flex items-center justify-center">
                    <div class="w-12 h-12 rounded-full bg-white/70 border border-slate-200 flex items-center justify-center text-slate-400">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6" aria-hidden="true">
                        <path d="M4 5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5Zm2 0v14h12V5H6Zm2.5 9.5 2-2 2 2.5 2.5-3L18 16H8.5Z" />
                      </svg>
                    </div>
                  </div>
                )}
              </div>

              <div class="p-6 flex flex-col flex-1">
                <p class="text-xs font-semibold text-blue-600 uppercase tracking-wide">
                  {post.category}
                </p>

                <h3 class="mt-2 text-lg font-bold text-slate-900 group-hover:text-blue-700 transition">
                  {post.title}
                </h3>

                <p class="mt-3 text-sm text-slate-600 leading-relaxed">
                  {post.desc}
                </p>

                <div class="mt-auto pt-4 text-xs text-slate-500 flex items-center gap-2">
                  <span class="font-semibold">{post.author}</span>
                  <span>•</span>
                  <span>{post.date}</span>
                </div>
              </div>
            </a>
          );
        })}
      </div>
    </div>
  </section>
</MainLayout>
